name: Deploy to EC2

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 11
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'
        
    - name: Cache Gradle packages
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
          
    - name: Make gradlew executable
      run: chmod +x ./gradlew
      
    - name: Build with Gradle
      run: ./gradlew clean build -x test
      
    - name: Deploy to EC2
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_PRIVATE_KEY }}
        script: |
          # 애플리케이션 디렉토리 생성
          sudo mkdir -p /home/ubuntu/app
          sudo mkdir -p /home/ubuntu/logs
          sudo chown ubuntu:ubuntu /home/ubuntu/app
          sudo chown ubuntu:ubuntu /home/ubuntu/logs
          
          # 기존 프로세스 종료
          pkill -f "webfounder.*\.jar" || true
          sleep 5
          
          # 이전 JAR 파일 백업
          if [ -f /home/ubuntu/app/webfounder-0.0.1-SNAPSHOT.jar ]; then
            mv /home/ubuntu/app/webfounder-0.0.1-SNAPSHOT.jar /home/ubuntu/app/webfounder-0.0.1-SNAPSHOT.jar.bak
          fi
          
    - name: Copy JAR to EC2
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_PRIVATE_KEY }}
        source: "build/libs/webfounder-0.0.1-SNAPSHOT.jar"
        target: "/home/ubuntu/app/"
        strip_components: 2
        
    - name: Copy deploy script to EC2
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_PRIVATE_KEY }}
        source: "scripts/deploy.sh"
        target: "/home/ubuntu/"
        strip_components: 1
        
    - name: Start application
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_PRIVATE_KEY }}
        script: |
          chmod +x /home/ubuntu/deploy.sh
          /home/ubuntu/deploy.sh
          
    - name: Health check
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_PRIVATE_KEY }}
        script: |
          sleep 30
          curl -f http://localhost:8080/actuator/health || (echo "Health check failed" && exit 1)